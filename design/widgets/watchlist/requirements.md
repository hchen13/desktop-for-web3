# Watchlist 组件需求文档（迭代）

日期：2026-02-02

## 1. 背景
Watchlist 组件用于展示用户关注的 5 个币种的实时价格。当前需求迭代聚焦于：更轻量的编辑入口、基于缓存币种列表的自动补全、右键菜单的“数据同步”能力、完善的滚动事件拦截以避免桌面切换，以及**初始化时的连通性探测**以选择最优数据源路径。

## 2. 目标与非目标
### 2.1 目标
- 支持**单击币种名称**进入该槽位的编辑对话框。
- 编辑对话框中对输入提供**自动补全**（基于币种列表缓存），且**必须从候选项中选择**。
- 对话框出现时，**垂直滚动事件不再冒泡**，避免触发桌面切换。
- 右键菜单新增“数据同步”选项，执行币种列表与价格缓存同步。
- 初始化时进行**连通性探测**，选择 Binance 或 Binance.US 作为后续请求路径。
- 行情数据来源遵循已选路径（不再按请求失败顺序切换）。

### 2.2 非目标
- 不新增/修改任何交易功能。
- 不变更 watchlist 的槽位数量（仍为 5 个）。
- 不引入用户自定义图标或排序规则。

## 3. 角色与使用场景
- 普通用户：快速替换某个币种为其他币种。
- 重度用户：右键主动触发数据同步，确保列表与价格缓存最新。

## 4. 交互与流程
### 4.1 入口与触发
- **单击币种名称**：打开“编辑对话框”，定位到被点击的槽位。
- **右键菜单**：提供“数据同步”选项（无“编辑”选项）。

### 4.2 编辑对话框
- 对话框标题：`编辑 Watchlist`。
- 展示 5 个槽位（当前币种）。
- 点击某个槽位后出现输入框（或该槽位变为输入状态）。
- 自动补全下拉出候选列表，用户必须**选择**候选项。
- 禁止将**原始用户输入**直接保存为 symbol。
- 对话框中还展示**全币种列表**：
  - **数据源为 Binance.com**：显示**分类 Tab**（按 Binance.com 分类或标签分组）。
  - **数据源为 Binance.US**：不显示分类 Tab，直接平铺列表。
- 全币种列表与输入补全应共享同一币种列表缓存。

### 4.3 滚动事件拦截
- 当编辑对话框可见时，**垂直滚动事件不再冒泡**。
- 目的：避免触发桌面切换（网格/页面切换）。

### 4.4 数据同步（右键菜单）
- 点击“数据同步”后：
  1) 调用**币种列表 API**，刷新币种列表缓存。
  2) 调用**当前监控 symbol 价格 API**，刷新价格缓存。
- 两步均成功后，界面中显示的价格与符号建议应基于最新缓存。

## 5. 数据源与缓存
### 5.1 数据来源
- 主源：Binance.com API。
- 备用源：Binance.US API。
- **连通性探测**（初始化时执行一次）：
  - Binance.com：Spot API `ping`（参考官方文档）。
  - Binance.US：`test-connectivity`（参考官方文档）。
  - 首次探测成功的路径被设为当前组件的**数据源路径**，后续请求均走该路径。
  - 若两个探测都失败：进入降级模式，使用本地缓存（若有）。

### 5.2 缓存要求
- **币种列表缓存**：
  - 作为自动补全数据源。
  - 支持刷新（右键“数据同步”触发）。
- **价格缓存**：
  - 初始化时会调用一次（已有实现）。
  - “数据同步”需再次触发全量刷新。

## 6. 自动补全规则
### 6.1 输入匹配
- 支持输入**币种全称**或**缩写**（例如 `bitcoin` / `BTC`）。
- 大小写不敏感。

### 6.2 候选约束
- 只能从候选列表选择。
- 未选择候选时，**禁止保存**。
- 若无匹配候选，提示“未找到匹配币种”。

### 6.3 候选展示
- 候选项展示格式：`全称 (SYMBOL)`。
- 若候选列表为空或缓存尚未加载，展示加载/空态提示。

## 7. 状态与反馈
- **成功保存**：槽位显示更新后的币种名称与价格。
- **保存失败**（例如缓存为空、选项无效）：阻止保存并提示原因。
- **同步成功**：提示“同步完成”。
- **同步部分失败**：提示失败项（币种列表或价格）。
- **同步完全失败**：提示“同步失败，请稍后重试”。

## 8. 异常与降级
- 连通性探测失败时：
  - 编辑对话框仍可打开，但候选提示为不可用/空列表。
  - 价格显示使用上一次缓存（若有）。
- 运行期间不做“请求失败 → 切换源”的自动切换，仅在下次初始化时重新探测。

## 9. 边界条件
- 用户连续快速点击不同槽位：只保留一个编辑上下文，切换焦点到最新槽位。
- 用户输入后未选择候选直接保存：应被拦截。
- 缓存为空：自动补全无候选、保存被阻止。
- 当前槽位选择与原值相同：允许保存但不触发写入（可视为无变化）。

## 10. 可用性与可访问性
- 输入框获得焦点时可直接键入。
- 候选支持键盘上下选择与回车确认。
- Escape 关闭对话框并丢弃未保存更改。

## 11. 验收标准（摘要）
1) 单击币种名称可进入编辑对话框并定位到对应槽位。
2) 自动补全来源于币种列表缓存，且必须从候选选择。
3) 编辑对话框显示时垂直滚动不会触发桌面切换。
4) 右键菜单包含“数据同步”，并刷新币种列表缓存与价格缓存。
5) 初始化时完成连通性探测，并据此固定数据源路径。
6) 对话框中展示全币种列表，Binance.com 含分类 Tab，Binance.US 无 Tab。

## 12. 测试清单（要点）
- 单击任意币种名称进入编辑，其他区域不触发。
- 输入全称/缩写均有候选（大小写无关）。
- 未选择候选无法保存。
- “数据同步”成功后候选与价格刷新。
- 初始化探测可正确选择 Binance.com 或 Binance.US。
- 编辑对话框打开时滚动不切换桌面。

## 13. API 与数据流程参考
- API 细节与字段定义参考：[design/widgets/watchlist/binance-api.md](design/widgets/watchlist/binance-api.md)
- 槽位编辑对话框中使用该文档中列出的币种列表与价格 API。
