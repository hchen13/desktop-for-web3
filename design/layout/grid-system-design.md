# Grid System 设计说明文档

> **版本**: 1.2
> **创建日期**: 2025-01-14
> **最后更新**: 2025-01-28

---

## 目录

1. [核心概念](#1-核心概念)
2. [设计参数](#2-设计参数)
3. [Grid System 尺寸](#3-grid-system-尺寸)
4. [锚点定位系统](#4-锚点定位系统)
5. [初始布局定义](#5-初始布局定义)
6. [拖拽交互](#6-拖拽交互)
7. [名词术语](#7-名词术语)

---

## 1. 核心概念

### 1.1 [Grid Unit](#grid-unit)

[Grid Unit](#grid-unit) 是 Grid System 的基本单位尺寸，指单个网格单元格的宽度和高度。

```
┌─────────────┐
│  Grid Unit  │  ← 一个正方形单元格
│   (固定尺寸)  │
└─────────────┘
     72px × 72px
```

**关键特性：**
- [Grid Unit](#grid-unit) 的宽度和高度是**固定的**（72px）
- 窗口变大时，[Grid Unit](#grid-unit) 尺寸**不变**
- 窗口变大时，**显示更多的 Grid Unit（更多列/行）**

### 1.2 [Grid System](#grid-system)

[Grid System](#grid-system) 是由多个 [Grid Unit](#grid-unit) 组成的网格系统，用于布局桌面元素。

```
┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
│   │   │   │   │   │   │   │   │   │   │   │  ← 第1行
├───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
│   │   │   │   │   │   │   │   │   │   │   │  ← 第2行
├───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
│   │   │   │   │   │   │   │   │   │   │   │  ← 第3行
└───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘
  ↑   ↑   ↑   ↑   ↑   ↑   ↑   ↑   ↑   ↑   ↑
  0   1   2   3   4   5   6   7   8   9   10  ← 列索引
```

[Grid System](#grid-system) 应该**填满整个可用宽度和高度**，动态计算列数和行数。

---

## 2. 设计参数

### 2.1 尺寸参数

| 参数 | 值 | 说明 |
|------|-----|------|
| [Grid Unit Size](#grid-unit-size) | 72px | 单个网格单元的边长 |
| [Grid Gap](#grid-gap) | 8px | 网格单元之间的间隙 |

### 2.2 计算公式

```
单个 Grid Cell 占用空间 = Grid Unit Size + Grid Gap
                        = 72px + 8px = 80px

Grid Area 宽度 = 列数 × (Grid Unit Size + Grid Gap) - Grid Gap
               = 列数 × 80px - 8px

Grid Area 高度 = 行数 × (Grid Unit Size + Grid Gap) - Grid Gap
               = 行数 × 80px - 8px
```

---

## 3. Grid System 尺寸

### 3.1 动态列数计算

[Grid System](#grid-system) 的列数应根据视口宽度动态计算。计算公式如下：

```
可用宽度 = 视口宽度 - Sidebar 宽度 - 左右 Padding
列数 = floor(可用宽度 / (Grid Unit Size + Grid Gap))
最小列数 = 6
```

### 3.2 示例计算

| 视口宽度 | Sidebar + Padding | 可用宽度 | 列数 | Grid Area 宽度 |
|----------|-------------------|----------|------|----------------|
| 1280px | 104px | 1176px | 14 | 1112px |
| 1920px | 104px | 1816px | 22 | 1752px |
| 2560px | 104px | 2456px | 30 | 2392px |

### 3.3 动态行数计算

```
可用高度 = 视口高度 - 顶部 Padding - 底部 Padding
行数 = floor(可用高度 / (Grid Unit Size + Grid Gap))
最小行数 = 6
```

---

## 4. 锚点定位系统

### 4.1 锚点概念

[Anchor Point](#anchor-point)（锚点）是布局坐标系统的原点，位于 Grid Area **第一行的中心列**。

**锚点位置计算：**
```
锚点列索引 = floor(总列数 / 2)
锚点行索引 = 0
```

**偶数列处理：** 当 Grid Area 列数为偶数时，锚点取中间偏**左**的列。

```
示例：10列 Grid Area
列索引:  0   1   2   3   4   5   6   7   8   9
                        ▲
                    锚点列 = floor(10/2) = 5

示例：11列 Grid Area
列索引:  0   1   2   3   4   5   6   7   8   9   10
                        ▲
                    锚点列 = floor(11/2) = 5
```

### 4.2 锚点坐标系统

所有元素的位置使用**相对于锚点的坐标**（Anchor-Relative Position）保存：

- **x 坐标**：相对于锚点列的偏移量
  - 负数 = 锚点左侧
  - 正数 = 锚点右侧
  - 0 = 锚点所在列
- **y 坐标**：相对于锚点行（第一行）的偏移量
  - 始终 >= 0（元素不能超出 Grid Area 顶部）

```
                    锚点 (0, 0)
                        ▼
        ┌───┬───┬───┬───┬───┬───┬───┬───┬───┐
x偏移:  -4  -3  -2  -1   0  +1  +2  +3  +4   ← 第一行 (y=0)
        ├───┼───┼───┼───┼───┼───┼───┼───┼───┤
                                              ← 第二行 (y=1)
        ├───┼───┼───┼───┼───┼───┼───┼───┼───┤
                                              ← 第三行 (y=2)
        └───┴───┴───┴───┴───┴───┴───┴───┴───┘
```

### 4.3 坐标转换

**保存 → 渲染（锚点坐标 → 绝对坐标）：**
```
绝对列索引 = 锚点列索引 + 相对x坐标
绝对行索引 = 相对y坐标
```

**渲染 → 保存（绝对坐标 → 锚点坐标）：**
```
相对x坐标 = 绝对列索引 - 锚点列索引
相对y坐标 = 绝对行索引
```

### 4.4 设计优势

1. **窗口尺寸变化自动适配**：锚点随列数变化自动居中，布局整体保持居中
2. **拖拽行为稳定**：元素位置变化不会影响其他元素的锚点坐标，避免拖拽时的"漂移"现象
3. **跨屏幕一致性**：同一布局在不同屏幕宽度下保持相对位置关系

### 4.5 示例

以 14 列 Grid Area 为例，锚点列 = 7：

| 元素 | 锚点坐标 (x, y) | 绝对坐标 (x, y) | 说明 |
|------|----------------|----------------|------|
| 时间组件 | (-4, 0) | (3, 0) | 锚点左侧 4 列 |
| 搜索框 | (-2, 0) | (5, 0) | 锚点左侧 2 列，占 4 列宽 |
| 资讯组件 | (+2, 0) | (9, 0) | 锚点右侧 2 列 |
| 图标1 | (-2, 3) | (5, 3) | 搜索框正下方 |

---

## 5. 初始布局定义

### 5.1 布局原则

1. **所有元素使用锚点相对坐标**
2. **以搜索框为视觉中心**
3. 其余元素相对于搜索框排布

### 5.2 定位逻辑（使用锚点坐标）

所有位置使用相对于锚点的坐标，锚点位于第一行中心列：

```
步骤1: 定位搜索框
        ├─ 搜索框 [Grid Size](#grid-size) 为 1×4（1行4列）
        └─ 锚点坐标: (-2, 0)，即锚点左侧 2 列开始

步骤2: 定位时间组件（搜索框左侧紧贴）
        ├─ 时间组件 [Grid Size](#grid-size) 为 1×2（1行2列）
        └─ 锚点坐标: (-4, 0)，即搜索框左边界再左 2 列

步骤3: 定位应用图标（搜索框正下方）
        ├─ 图标 [Grid Size](#grid-size) 为 1×1（1行1列）
        ├─ 横向排列在搜索框下方对应区域
        └─ 锚点坐标: (-2, 3), (-1, 3), (0, 3), (1, 3) 等

步骤4: 定位 Widgets（图标左侧）
        ├─ Widget [Grid Size](#grid-size) 为 2×2（2行2列）
        └─ 锚点坐标: (-6, 1), (-6, 3) 等

步骤5: 定位资讯组件（搜索框右侧）
        ├─ 资讯 [Grid Size](#grid-size) 为 N×3（N行3列）
        └─ 锚点坐标: (2, 0)，即锚点右侧 2 列开始
```

### 5.3 布局示意图

以下示意图以 14 列 Grid System 为例，展示居中布局：

```
列索引:  0   1   2   3   4   5   6   7   8   9   10  11  12  13
        │   │   │   │   │   │   │   │   │   │   │   │   │   │
        ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│     │     │     │时间 │时间 │搜索 │搜索 │搜索 │搜索 │资讯 │资讯 │     │     │     │  第1行
│     │     │     │     │     │     │     │     │     │     │     │     │     │     │
├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤
│     │     │     │链上 │链上 │图标 │图标 │图标 │图标 │资讯 │资讯 │     │     │     │  第2行
│     │     │     │监控 │监控 │     │     │     │     │     │     │     │     │     │
├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤
│     │     │     │日历 │日历 │图标 │图标 │图标 │图标 │资讯 │资讯 │     │     │     │  第3行
│     │     │     │     │     │     │     │     │     │     │     │     │     │     │
├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤
│     │     │     │价格 │价格 │     │     │     │     │资讯 │资讯 │     │     │     │  第4行
│     │     │     │监控 │监控 │     │     │     │     │     │     │     │     │     │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘
                          ▲       ▲       ▲
                          │       │       │
                    中心列索引=7    搜索框占列4-7    资讯占列8-9
```

> **注：** 实际列数根据视口宽度动态计算，上图仅为示例。

### 5.4 元素 Grid 占用

| 元素 | [Grid Size](#grid-size) | 说明 |
|------|------------------------|------|
| 时间组件 | 1×2 | 1行2列 |
| 搜索框 | 1×4 | 1行4列 |
| 应用图标 | 1×1 | 1行1列 |
| Widget (链上/日历/价格) | 2×2 | 2行2列 |
| 资讯组件 | N×2 | N行2列（N为动态行数） |

---

## 6. 拖拽交互

### 6.1 拖拽规则

1. **吸附对齐**：元素拖拽释放后，自动吸附到最近的 [Grid Unit](#grid-unit) 边界
2. **边界限制**：元素不能被拖拽到 [Grid System](#grid-system) 边界之外
3. **防重叠**：元素不能与其他元素重叠（固定元素除外）
4. **固定元素**：时间、搜索框等固定元素不可拖拽

### 6.2 拖拽行为

#### 6.2.1 鼠标按下

| 行为 | 描述 |
|------|------|
| 记录偏移量 | 记录鼠标相对于元素左上角的偏移量，避免拖拽开始时元素跳动 |
| 悬浮动效 | 元素相对于其原始位置产生"抬起"效果，如轻微上移、阴影加深 |

#### 6.2.2 拖拽中

| 行为 | 描述 |
|------|------|
| 元素跟随 | 被拖拽元素跟随鼠标移动，保持鼠标偏移量 |
| 半透明状态 | 元素显示为半透明，表明处于拖拽状态 |
| 阴影预览 | 在 [Grid System](#grid-system) 上显示"阴影"效果，标记元素将被吸附到的 [Grid Unit](#grid-unit) |
| 预览染色 | 被阴影覆盖的 Grid Unit 需要被染色，表示如果在当前位置释放，元素将占用这些格子 |
| 元素挤压 | 其他元素需要被"阴影"挤压至更"轻松"的区域（空闲区域）|
| 挤压传递 | 挤压效果是传递的，A 被挤压可能推动 B，B 推动 C，以此类推 |
| 临时位移 | 拖拽过程中的元素挤压是临时的，不改变元素的实际位置 |

#### 6.2.3 释放

| 行为 | 描述 |
|------|------|
| 吸附对齐 | 元素吸附到阴影标记的 [Grid Position](#grid-position) |
| 冲突处理 | 使用 BFS 算法计算被占用元素的位移目标位置 |
| 永久位移 | 仅释放位置实际影响的元素需要被永久挤压 |
| 回弹恢复 | 未被最终释放影响的元素回到各自原来的位置 |
| 取消拖拽 | 如果释放位置无效（如超出边界），元素回到原始位置 |

### 6.3 视觉反馈

| 状态 | 视觉效果 |
|------|----------|
| 可拖拽元素 Hover | 轻微放大 + 阴影 |
| 鼠标按下（未拖动） | 元素上浮 + 阴影加深（悬浮动效） |
| 拖拽中 - 元素 | 半透明 + 放大 1.05 倍 + 强阴影 |
| 拖拽中 - 阴影预览 | 虚线边框 + 半透明蓝色背景覆盖目标 [Grid Unit](#grid-unit) |
| 拖拽中 - 被挤压元素 | 平滑过渡动画移动到临时位置 |
| 释放后回弹 | 平滑过渡动画回到原始位置 |
| 占位符 | 虚线边框 + 蓝色背景 |
| 无效位置 | 红色高亮提示 |

### 6.4 边界检测

#### 6.4.1 Grid System 边界

拖拽过程中，元素的位置必须满足：

```
element.x >= 0
element.y >= 0
element.x + element.width <= Grid System 列数
element.y + element.height <= Grid System 行数
```

#### 6.4.2 Viewport 边界

**硬性约束：** 拖拽过程和释放均不允许任何元素的任何部分超出 Viewport。

```
对于任意元素，其像素位置必须满足：
element.left >= 0
element.top >= 0
element.right <= Viewport.width
element.bottom <= Viewport.height
```

**实现要求：**
- 拖拽过程中实时检测元素边界
- 如果拖拽会导致元素超出 Viewport，限制拖拽范围
- 释放位置的验证必须同时满足 Grid System 边界和 Viewport 边界
- 如果无法在边界内找到有效位置，元素回到原始位置

### 6.5 拖拽状态流转

```
┌─────────┐
│ 鼠标按下 │ → 记录偏移量 → 显示悬浮动效
└────┬────┘
     │
     ▼ (鼠标移动 > 5px)
┌─────────┐
│ 进入拖拽 │ → 元素半透明 → 显示阴影预览 → 计算被挤压元素
└────┬────┘
     │
     ▼ (持续移动)
┌─────────┐
│ 拖拽中   │ → 更新阴影位置 → 更新预览染色 → 更新被挤压元素临时位置
└────┬────┘
     │
     ▼ (鼠标释放)
┌─────────┐
│ 释放     │ → 验证边界 → 计算最终位置 → 执行永久位移或回弹
└─────────┘
```

---

## 7. 名词术语

<details>
<summary><b>点击展开术语表</b></summary>

### Grid Unit

单个网格单元格，是 [Grid System](#grid-system) 的最小单位。呈正方形，边长固定为 72px。

### Grid Unit Size

[Grid Unit](#grid-unit) 的尺寸，指单个网格单元的边长。本项目中固定为 72px。

### Grid Gap

网格单元之间的间隙，用于在视觉上分隔不同的元素。本项目中为 8px。

### Grid System

由多个 [Grid Unit](#grid-unit) 组成的网格系统，用于定义和约束桌面元素的布局。Grid System 的列数和行数根据视口尺寸动态计算。

### Grid Area

[Grid System](#grid-system) 在页面中实际占据的矩形区域。其宽度和高度由当前的列数、行数以及 [Grid Unit Size](#grid-unit-size) 和 [Grid Gap](#grid-gap) 决定。

### Grid Size

元素在 [Grid System](#grid-system) 中占用的尺寸，以 [Grid Unit](#grid-unit) 数量表示。

**格式：** `{ width: number, height: number }`

**简记：** `行数×列数`，例如 `2×3` 表示 2 行 3 列

**示例：**
- `{ width: 2, height: 1 }` 或记作 `1×2`：1 行 2 列
- `{ width: 3, height: 2 }` 或记作 `2×3`：2 行 3 列
- `{ width: 1, height: 1 }` 或记作 `1×1`：1 行 1 列

### Grid Position

元素在 [Grid System](#grid-system) 中的位置，以列索引和行索引表示。

**格式：** `{ x: number, y: number }`

- `x`：列索引（从左到右，从 0 开始）
- `y`：行索引（从上到下，从 0 开始）

**示例：** `{ x: 2, y: 3 }` 表示元素位于第 3 列第 4 行

### Anchor Point

锚点，布局坐标系统的原点，位于 [Grid Area](#grid-area) **第一行的中心列**。

**计算方式：** `锚点列索引 = floor(总列数 / 2)`

当列数为偶数时，锚点取中间偏左的列。所有元素的位置都相对于锚点保存，使布局在不同屏幕宽度下自动居中。

### Anchor-Relative Position

相对于 [Anchor Point](#anchor-point) 的坐标位置。

**格式：** `{ x: number, y: number }`

- `x`：相对于锚点列的偏移量（负数=左侧，正数=右侧）
- `y`：相对于锚点行的偏移量（始终 >= 0）

**示例：** `{ x: -2, y: 1 }` 表示元素位于锚点左侧 2 列、下方 1 行

### Viewport

浏览器窗口中可见的页面区域，其宽度和高度决定了 [Grid System](#grid-system) 的列数和行数。

### Sidebar

固定在页面左侧的系统导航区域，宽度为 72px，不占用 [Grid System](#grid-system) 的任何列。

### Fixed Element

固定位置的元素，不可拖拽，包括时间组件、搜索框等。

### Draggable Element

可拖拽的元素，包括 Widget、应用图标等。

</details>
